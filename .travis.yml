language: generic
dist: xenial
sudo: enabled
os:
  - osx
  - linux

env:
  global:
    - ANDROID_HOME=${HOME}/android-sdk
    - ANDROID_SDK_TOOLS_VERSION=4333796
    - ANDROID_BUILD_TOOLS_VERSION="28.0.3"
    - ANDROID_PLATFORM_VERSION=28
    - BAZELISK_VERSION="0.0.8"
    - PATH=${PATH}:${ANDROID_HOME}/tools/bin:${HOME}/bin
  matrix:
    - USE_BAZEL_VERSION="0.26.1" SEGMENT="."
    - USE_BAZEL_VERSION="0.26.1" SEGMENT="test/test_workspace"
    - USE_BAZEL_VERSION="0.27.0" SEGMENT="."
    - USE_BAZEL_VERSION="0.27.0" SEGMENT="test/test_workspace"
    - USE_BAZEL_VERSION="0.27.1" SEGMENT="."
    - USE_BAZEL_VERSION="0.27.1" SEGMENT="test/test_workspace"
    - USE_BAZEL_VERSION="0.27.2" SEGMENT="."
    - USE_BAZEL_VERSION="0.27.2" SEGMENT="test/test_workspace"
    - USE_BAZEL_VERSION="0.28.0" SEGMENT="."
    - USE_BAZEL_VERSION="0.28.0" SEGMENT="test/test_workspace"

addons:
  apt:
    packages:
      - wget
      - openjdk-8-jdk
  homebrew:
    taps:
      - adoptopenjdk/openjdk
    casks:
      - adoptopenjdk8
    update: true

before_install:
  - if [ "osx" == "${TRAVIS_OS_NAME}" ]; then export PLATFORM="darwin" ; else export PLATFORM="${TRAVIS_OS_NAME}" ; fi
  - if [ "osx" == "${TRAVIS_OS_NAME}" ]; then export JAVA_HOME="/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home" ; fi
  - if [ "linux" == "${TRAVIS_OS_NAME}" ]; then export JAVA_HOME="/usr/lib/jvm/java-8-openjdk-amd64" ; fi
  - mkdir -p $HOME/bin
  - mkdir -p ${ANDROID_HOME}
  - ls -FaCl ${JAVA_HOME}/bin

install:
  - # Download android SDK
  - (cd ${HOME} && wget https://dl.google.com/android/repository/sdk-tools-${PLATFORM}-${ANDROID_SDK_TOOLS_VERSION}.zip)
  - (cd ${ANDROID_HOME} && unzip ${HOME}/sdk-tools-${PLATFORM}-${ANDROID_SDK_TOOLS_VERSION}.zip)
  - yes | ${ANDROID_HOME}/tools/bin/sdkmanager "platform-tools" > /dev/null
  - yes | ${ANDROID_HOME}/tools/bin/sdkmanager "platforms;android-${ANDROID_PLATFORM_VERSION}" >/dev/null
  - yes | ${ANDROID_HOME}/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS_VERSION}" >/dev/null
  - ${ANDROID_HOME}/tools/bin/sdkmanager --list
  - (cd ${HOME} && wget https://github.com/bazelbuild/bazelisk/releases/download/v${BAZELISK_VERSION}/bazelisk-${PLATFORM}-amd64)
  - install ${HOME}/bazelisk-${PLATFORM}-amd64 ${HOME}/bin/bazel
  - chmod a+x ${HOME}/bin/bazel
  - java -version
  - bazel version

script:
  - # Test each root in the build matrix.
  - cd ${HOME}/build/${TRAVIS_REPO_SLUG}/${SEGMENT}
  - bazel test //...

cache:
  directories:
    - $HOME/.cache/bazel_maven_repository
